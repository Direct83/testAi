#!/usr/bin/env bash
set -euo pipefail

# Git Bash friendly pre-push hook.
# Триггерит локального агента, если в пуше есть изменения в tasks/.

REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT"

# Подтянем переменные из .env, если есть
if [ -f .env ]; then
  # shellcheck disable=SC2046
  export $(grep -E '^(OPENAI_API_KEY|OPENAI_MODEL|GITHUB_TOKEN|GITHUB_REPOSITORY|BASE_BRANCH|MCP_SERVER|HEAD_BRANCH_PREFIX)=' .env | xargs -0 -I {} echo {} ) 2>/dev/null || true
fi

# Значения по умолчанию
: "${MCP_SERVER:=http://127.0.0.1:8081}"

echo "[pre-push] MCP_SERVER=${MCP_SERVER}"
# Если текущий MCP_SERVER недоступен — пробуем типовые локальные адреса
if ! curl -fsS "${MCP_SERVER}/capabilities" >/dev/null 2>&1; then
  for candidate in http://127.0.0.1:8081 http://localhost:8081; do
    if curl -fsS "${candidate}/capabilities" >/dev/null 2>&1; then
      MCP_SERVER="$candidate"
      export MCP_SERVER
      echo "[pre-push] MCP_SERVER fallback -> ${MCP_SERVER}"
      break
    fi
  done
fi

# Определяем диапазон коммитов, который пушится
upstream=$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null || true)
if [ -n "$upstream" ]; then
  RANGE="$upstream..HEAD"
else
  RANGE="HEAD~5..HEAD" # fallback
fi

changed=$(git diff --name-only $RANGE | grep -E '^tasks/' || true)
if [ -z "$changed" ]; then
  exit 0
fi

echo "[pre-push] tasks/ changed. Running agent via MCP: $MCP_SERVER"

"${PYTHON:-python}" agent/agent_mcp_github.py || {
  echo "[pre-push] Agent failed. Canceling push." >&2
  exit 1
}

exit 0


